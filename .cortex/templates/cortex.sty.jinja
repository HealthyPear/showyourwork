\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{cortex}[2021/07/07 Open source science articles]


% Imports
\RequirePackage{mathtools} % equation tags
\RequirePackage{xcolor} % custom colors
\RequirePackage[hidelinks]{hyperref} % url links
\RequirePackage{suffix} % allows definition of starred commmands
\RequirePackage{ifxetex}
\ifxetex
  \RequirePackage{fontspec}
  \defaultfontfeatures{Extension = .otf}
\fi
\RequirePackage{fontawesome} % FontAwesome symbols
\RequirePackage{letltxmacro} % command redefinitions
\RequirePackage{xstring} % string manipulation
\RequirePackage{catchfile} % read file into macro
\RequirePackage{totcount} % count total number of errors
\RequirePackage[notref, notcite]{showkeys} % get label refs
\RequirePackage{marginnote} % margin notes


((* if gen_tree *))

% Logging
\newwrite\ctxLogFile
\immediate\openout\ctxLogFile=cortex.xml
\newcommand\ctxLogMessage[1]{%
  \protected@write
  \ctxLogFile
  {\let\tmp\write\def\write{\immediate\tmp}}%
  {#1}%
}
\ctxLogMessage{<HTML>}
\AtEndDocument{\ctxLogMessage{</HTML>}}

% Log all figure and equation labels
\renewcommand\showkeyslabelformat[1]{%
  \IfBeginWith*{#1}{eq:}{%
    % Equation label
    \StrBehind*{#1}{eq:}[\ctxCurrentLabelName]
    \ctxLogMessage{<LABEL>\ctxCurrentLabelName</LABEL>}%
  }{}
  \IfBeginWith*{#1}{fig:}{%
    % Figure label
    \StrBehind*{#1}{fig:}[\ctxCurrentLabelName]
    \ctxLogMessage{<LABEL>\ctxCurrentLabelName</LABEL>}%
  }{}
}

% Log figures
\let\oldfigure\figure
\let\oldendfigure\endfigure
\renewenvironment{figure}{%
  \ctxLogMessage{<FIGURE>}%
  \oldfigure%
}{%
  \oldendfigure%
  \ctxLogMessage{</FIGURE>}%
}

% Log equations
\let\oldalign\align
\let\oldendalign\endalign
\renewenvironment{align}{%
  \ctxLogMessage{<ALIGN>}%
  \oldalign%
}{%
  \oldendalign%
  \ctxLogMessage{</ALIGN>}%
}

% Log figure captions
\renewcommand{\caption}{%
  \ctxLogMessage{<CAPTION />}%
}

% Log graphics
\renewcommand{\includegraphics}[2][]{%
  \ctxLogMessage{<GRAPHICS>#2</GRAPHICS>}%
}

% Disable author info
\newcommand{\myName}{}
\newcommand{\myEmail}{}
\newcommand{\myAffil}{}
\newcommand{\myORCID}{}
\renewcommand{\author}[2][]{}
\renewcommand{\email}{}
\renewcommand{\affil}{}

% Disable bibliography
\renewcommand{\bibliography}[1]{}

((* else *))

% Author info
\newcommand{\myName}{((- author.name -))}
\newcommand{\myEmail}{((- author.email -))}
\newcommand{\myAffil}{((- author.affil -))}
\newcommand{\myORCID}{((- author.orcid -))}

% Logging
\newwrite\ctxLogFile
\immediate\openout\ctxLogFile=cortex.log
\newcommand\ctxLogMessage[1]{%
  \protected@write
  \ctxLogFile
  {\let\tmp\write\def\write{\immediate\tmp}}%
  {#1}%
}
\ctxLogMessage{This is CorTeX v((- version -)).}

% Define custom colors
\definecolor{ctxRed}{rgb}{0.80,0.14,0.19}
\definecolor{ctxOrange}{rgb}{1.0,0.65,0.0}
\definecolor{ctxYellow}{rgb}{1.0,0.88,0.30}
\definecolor{ctxBlue}{rgb}{0.12,0.47,0.71}

% Error codes (colors)
\colorlet{ctxScriptDoesNotExist}{ctxRed}
\colorlet{ctxScriptNotVersionControlled}{ctxOrange}
\colorlet{ctxScriptHasUncommittedChanges}{ctxYellow}
\colorlet{ctxScriptUpToDate}{ctxBlue}

% Key-value pairs
% See https://tex.stackexchange.com/a/48931
\def\addvalue#1#2{\expandafter\gdef\csname ctx@data@\detokenize{#1}\endcsname{#2}}
\def\usevalue#1{%
\ifcsname ctx@data@#1\endcsname%
  \csname ctx@data@#1\expandafter\endcsname%
\else%
  \expandafter\ERROR
\fi%
}
((* for key, value in labels.items() *))
\addvalue{((- key -))}{((- value -))}
((* endfor *))

% Add a GitHub link to the end of the abstract
\let\oldabstract\abstract
\let\oldendabstract\endabstract
\renewenvironment{abstract}{%
  \oldabstract%
}{%
  \marginnote{%
    \href{((- repo.url -))}{%
      \color{((- status -))}%
      \faGithub%
    }
  }
  \oldendabstract%
}

% Hack `showkeys' to show a GitHub link for figures & equations
% See https://tex.stackexchange.com/a/580553
\renewcommand\showkeyslabelformat[1]{%
  \IfBeginWith*{#1}{eq:}{\StrBehind*{#1}{eq:}[\ctxCurrentLabelName]%
    \normalfont%
    \href{((- repo.url -))/blob/((- sha -))/tests/\usevalue{\ctxCurrentLabelName_script}}{%
      \color{\usevalue{\ctxCurrentLabelName_status}}\faGithub%
    }%
  }{}%
  \IfBeginWith*{#1}{fig:}{\StrBehind*{#1}{fig:}[\ctxCurrentLabelName]%
    \normalfont%
    \href{((- repo.url -))/blob/((- sha -))/figures/\usevalue{\ctxCurrentLabelName_script}}{%
      \color{\usevalue{\ctxCurrentLabelName_status}}\faGithub%
    }%
  }{}%
}

% Set the graphics path for all figures
\graphicspath{{../figures/}}

((* endif *))